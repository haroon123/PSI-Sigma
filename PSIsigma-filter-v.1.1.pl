=begin
PSI-Sigma: A splicing-detection method for short-read and long-read RNA-seq data
Â© Kuan-Ting Lin, 2018-2024
PSI-Sigma is free for non-commercial purposes by individuals at an academic or non-profit institution.
For commercial purposes, please contact tech transfer office of CSHL via narayan@cshl.edu
=end
=cut
use strict;my($db,$mapping,$input,$nofilter)=@ARGV;my$criteria=0.75;my%symbol;my%strand;print"\x52\x65\x61\x64\x69\x6E\x67\x2E\x2E\x2E\x20$mapping\n";open(FILE,"$mapping")||die"\x41\x62\x6F\x72\x74\x69\x6E\x67\x2E\x2E\x20\x43\x61\x6E\x27\x74\x20\x6F\x70\x65\x6E\x20$mapping\x20\x3A\x20$!\n";while(my$line=<FILE>){chomp$line;my($ENST,$symbol,$strand)=split(/\t/,$line);$symbol{$ENST}=$symbol;$strand{$ENST}=$strand}close(FILE);print"\x52\x65\x61\x64\x69\x6E\x67\x2E\x2E\x2E\x20$db\n";my%ET;my%names;open(FILE,"$db")||die"\x41\x62\x6F\x72\x74\x69\x6E\x67\x2E\x2E\x20\x43\x61\x6E\x27\x74\x20\x6F\x70\x65\x6E\x20$db\n";while(my$line=<FILE>){chomp$line;next if($line eq"");my($chr,$i1s,$i1e,$i2s,$i2e,$tes,$tee,$anno,$as,$ae,$name,$gn)=split(/\t/,$line);my($et)="\x2D";my($accession,$num)=($1,$2)if($name=~/(\w+)\_(\d+)$/);my($ENST)=($1)if($accession=~/\_ENST(\d+)/);if($name=~/\_R1\./||$name=~/\_R2\./){$name=~s/\./\_/g;($accession,$num)=($1,$2)if($name=~/(\w+)\_(\d+)$/);$ENST=$accession;$ENST=~s/(.*)\_R1/R1/;$ENST=~s/(.*)\_R2/R2/}else{$ENST="\x45\x4E\x53\x54".$ENST}if($name=~/\_W\_/){if($i1s==$as&&$i2e==$ae){$ET{$accession}="\x53\x45\x53"if($num==1)}else{$ET{$accession}="\x4D\x45\x53"if($num>1)}}if($name=~/\_S\_/){if($i1s==$i1e){$ET{$accession}="\x41\x33\x53\x53"if($strand{$ENST}eq"\x2B");$ET{$accession}="\x41\x35\x53\x53"if($strand{$ENST}eq"\x2D")}if($i2s==$i2e){$ET{$accession}="\x41\x35\x53\x53"if($strand{$ENST}eq"\x2B");$ET{$accession}="\x41\x33\x53\x53"if($strand{$ENST}eq"\x2D")}}if($name=~/\_R\_/){$ET{$accession}="\x49\x52";$ET{$accession}="\x49\x52\x20\x28\x6F\x76\x65\x72\x6C\x61\x70\x70\x69\x6E\x67\x20\x72\x65\x67\x69\x6F\x6E\x29"if($gn=~/\,/)}}close(FILE);my%output;my%asae;my%es;my%ee;my%exonR;my($maxn,$maxt)=(0,0);open(FILE,"$input")||die"\x41\x62\x6F\x72\x74\x69\x6E\x67\x2E\x2E\x20\x43\x61\x6E\x27\x74\x20\x6F\x70\x65\x6E\x20$input\x20\x3A\x20$!\n";while(my$line=<FILE>){chomp$line;next if($line=~/^Event ID/);my($ID,$tmpgn,$exon,$eventtype,$N,$T,$exontype,$ENST,$dPSI,$pvalue,$FDR,$nvalues,$tvalues)=split(/\t/,$line);if($nofilter==0){next if($pvalue>=0.01||abs($dPSI)<=10)}else{next if(abs($dPSI)<=10)}$maxn=$N if($maxn<$N);$maxt=$T if($maxt<$T);$line=~s/\, /\|/g;my($chr,$as,$ae,$t,$tmpENST,$num)=split(/\_/,$ID);$chr=~s/chr//;my($exonchr,$exonss,$exonee)=split(/[\:\-]/,$exon);if($eventtype eq"\x52"){$exon="$chr:$as\x2D$ae"}if(!$output{"$exon\t$eventtype"}){$output{"$exon\t$eventtype"}=$line}else{my@tmparray=split(/\t/,$output{"$exon\t$eventtype"});my$tmpp=$tmparray[9];next if($tmpp<=$pvalue);$output{"$exon\t$eventtype"}=$line}if($eventtype eq"\x57"){$es{$exonss}++;$ee{$exonee}++;$asae{"$chr\t$as\t$ae"}{"$exonss\t$exonee"}++}if($eventtype eq"\x52"){$exonR{$exon}++}}close(FILE);$input=~s/\.txt$//;my$outfn=$input."\x2E\x73\x6F\x72\x74\x65\x64\x2E\x74\x78\x74";my$tmpfn=$input."\x2E\x66\x69\x6C\x74\x65\x72\x65\x64\x2E\x74\x78\x74";open(OUT,"\x3E".$tmpfn)||die"\x41\x62\x6F\x72\x74\x69\x6E\x67\x2E\x2E\x20\x43\x61\x6E\x27\x74\x20\x6F\x70\x65\x6E\x20".$tmpfn."\x20\x3A\x20$!\n";print OUT"\x45\x76\x65\x6E\x74\x20\x52\x65\x67\x69\x6F\x6E\x09\x47\x65\x6E\x65\x20\x53\x79\x6D\x62\x6F\x6C\x09\x54\x61\x72\x67\x65\x74\x20\x45\x78\x6F\x6E\x09\x45\x76\x65\x6E\x74\x20\x54\x79\x70\x65\x09\x4E\x09\x54\x09\x45\x78\x6F\x6E\x20\x54\x79\x70\x65\x09\x52\x65\x66\x65\x72\x65\x6E\x63\x65\x20\x54\x72\x61\x6E\x73\x63\x72\x69\x70\x74\x09\xCE\x94\x50\x53\x49\x20\x28\x25\x29\x09\x54\x2D\x74\x65\x73\x74\x20\x70\x2D\x76\x61\x6C\x75\x65\x09\x46\x44\x52\x20\x28\x42\x48\x29\x09\x4E\x20\x56\x61\x6C\x75\x65\x73\x09\x54\x20\x56\x61\x6C\x75\x65\x73\n";foreach my$exoninfo(keys%output){my($ID,$tmpgn,$exon,$eventtype,$N,$T,$exontype,$ENST,$dPSI,$pvalue,$FDR,$nvalues,$tvalues)=split(/\t/,$output{$exoninfo});if($eventtype eq"\x52"){if(!$exonR{$exon}){}else{}}my($chr,$as,$ae,$tmp,$tmpENST,$tmpnum)=split(/\_/,$ID);$chr=~s/chr//;my($accession,$num)=($1,$2)if($ID=~/(\w+)\_(\d+)$/);if($ID=~/\_R1\./||$ID=~/\_R2\./){$ENST=~s/\./\_/g;$ID=~s/\./\_/g;($accession,$num)=($1,$2)if($ID=~/(\w+)\_(\d+)$/)}if($nofilter==0){next if($N<($maxn*$criteria)||$T<($maxt*$criteria))}my$symbol="\x2D";if(!$symbol{$ENST}){$symbol="\x4E\x2F\x41";print"$ENST\x20\x68\x61\x73\x20\x6E\x6F\x20\x73\x79\x6D\x62\x6F\x6C\x21\n"}else{$symbol=$symbol{$ENST}}if(!$ET{$accession}){print"\x43\x61\x6E\x27\x74\x20\x66\x69\x6E\x64\x20$accession\n";exit}else{$eventtype=$ET{$accession}}if($eventtype eq"\x53\x45\x53"){my$mxs=0;my($exonchr,$exonss,$exonee)=split(/[\:\-]/,$exon);foreach my$loc(keys%{$asae{"$chr\t$as\t$ae"}}){my($es,$ee)=split(/\t/,$loc);next if($exonss<=$es&&$exonee>=$es);next if($exonss<=$ee&&$exonee>=$ee);next if($es<$exonss&&$ee>$exonee);$mxs=1;last}$eventtype="\x4D\x58\x53"if($mxs==1)}if($eventtype eq"\x41\x35\x53\x53"||$eventtype eq"\x41\x33\x53\x53"){my($exonchr,$exonss,$exonee)=split(/[\:\-]/,$exon);if(!$es{$exonss}&&!$ee{$exonee}){}else{next}}my$eventregion="$chr:$as\x2D$ae";my($exonchr,$exonss,$exonee)=split(/[\:\-]/,$exon);if($eventtype=~/IR/){$eventregion=$exon;$exon="$chr:$as\x2D$ae"}print OUT"$eventregion\t$symbol\t$exon\t$eventtype\t$N\t$T\t$exontype\t$ENST\t$dPSI\t$pvalue\t$FDR\t$nvalues\t$tvalues\n"}close(OUT);my$sortcommand="\(\x68\x65\x61\x64\x20\-\x6E\x20\x31\x20".$tmpfn."\x20\&\&\x20\x74\x61\x69\x6C\x20\-\x6E\x20\+\x32\x20".$tmpfn."\x20\|\x20\x73\x6F\x72\x74\x20\-\x67\x72\x20\-\x74\x20\x27\t\x27\x20\-\x6B\x20\x39\)\x20\>\x20".$outfn."\n";system($sortcommand)